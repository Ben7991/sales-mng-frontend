<div class="sales-management-container">
  <div class="filter-section">
    <app-search
      [config]="salesSearchConfig"
      [value]="searchTerm()"
      (searchTermChange)="onUserSearchTermChange($event)"
      (searchCleared)="onSearchCleared()"
    />

    <div class="filter-actions">
      <app-button
        text="Filter"
        variant="outlined"
        [matMenuTriggerFor]="filterMenu"
        class="filter-button"
      >
        <mat-icon>expand_more</mat-icon>
      </app-button>

      <mat-menu #filterMenu="matMenu" class="popup-menu">
        <button mat-menu-item [matMenuTriggerFor]="roleMenu">
          Filter by customer
        </button>
        <button mat-menu-item [matMenuTriggerFor]="paidMenu">
          Filter by paid status
        </button>
        <button mat-menu-item [matMenuTriggerFor]="statusMenu">
          Filter by order status
        </button>
        <mat-divider></mat-divider>
        <button mat-menu-item (click)="filterStatus('')">Clear filter</button>
      </mat-menu>

      <!-- Role submenu -->
      <mat-menu #roleMenu="matMenu" class="popup-menu submenu">
        <div class="supplier-list-scroll-container">
          @if (isLoadingCustomers()) {
            <button mat-menu-item disabled>Loading suppliers...</button>
          } @else if (customers() && customers()!.length === 0) {
            <button mat-menu-item disabled>No suppliers found</button>
          } @else {
            @for (customer of customers() || []; track customer.id) {
              <button
                mat-menu-item
                (click)="filterBySupplier(customer)"
                [class.active]="activeCustomerId() === customer.id"
              >
                {{ customer.name }}
              </button>
            }
          }
        </div>
      </mat-menu>

      <mat-menu #paidMenu="matMenu" class="popup-menu submenu">
        <button mat-menu-item (click)="filterStatus('PAID')">Paid</button>
        <button mat-menu-item (click)="filterStatus('OUTSTANDING')">Outstanding</button>
      </mat-menu>

      <!-- Status submenu -->
      <mat-menu #statusMenu="matMenu" class="popup-menu submenu">
        <button mat-menu-item (click)="filterStatus('OPEN')">Open</button>
        <button mat-menu-item (click)="filterStatus('DELIVERED')" >Delivered</button>
      </mat-menu>

      <app-button
        (click)="openCreateOrderModal()"
        icon="assets/addIcon.svg"
        [isIconButton]="true"
        text="create order"
        [styles]="{ height: '40px',width: '140px' }"
      />
    </div>
  </div>
</div>
@if (salesService.isLoadingOrders()) {
  <div class="loader">
    <mat-spinner diameter="50"></mat-spinner>
  </div>
}
@else {
  <div class="sales-table--canvas">
    <div class="sales-table">
      <div class="table-name">Orders ({{ salesService.ordersCount() }})</div>

      <app-table
        [columns]="tableColumns"
        [data]="salesService.orders() ?? []"
        [actionsTemplate]="actionsTemplate"
        [loading]="isLoading$()"
        [showCheckboxes]="false"
        [isRowClickable]="true"
        [showPagination]="salesService.ordersCount() > 10"
        [pageSize]="salesService.currentPageSize"
        [currentPage]="salesService.currentPage"
        [totalItems]="salesService.ordersCount()"
        [statusConfig]="statusConfig"
        (pageChange)="onPageChange($event)"
        (clickedRow)="onRowItemClick($event)"
      />

      <ng-template #actionsTemplate let-order>
        @if (order.orderStatus?.toLowerCase() !== 'delivered') {
          <button
            mat-icon-button
            class="action-menu-button"
            [matMenuTriggerFor]="orderMenu"
            (click)="$event.stopPropagation()">
            <mat-icon>more_vert</mat-icon>
          </button>

          <mat-menu #orderMenu="matMenu" class="popup-menu">
            @if (order.orderStatus?.toLowerCase() === 'open') {
              <button mat-menu-item (click)="onActionClick({action: 'edit', item: order, originalEvent: $event})">
                <span>Edit Order</span>
              </button>
              <button mat-menu-item [matMenuTriggerFor]="statusMenu">
                <span>Change Status</span>
              </button>
            } @else if (order.orderStatus?.toLowerCase() === 'deemed satisfied') {
              <button mat-menu-item (click)="onActionClick({action: 'mark-delivered', item: order, originalEvent: $event})">
                <span>Mark as Delivered</span>
              </button>
            }
          </mat-menu>

          <mat-menu #statusMenu="matMenu" class="popup-menu submenu">
            <button mat-menu-item (click)="onActionClick({action: 'deemed-satisfied', item: order, originalEvent: $event})">
              <span>Deemed Satisfied</span>
            </button>
            <button mat-menu-item (click)="onActionClick({action: 'mark-delivered', item: order, originalEvent: $event})">
              <span>Mark as Delivered</span>
            </button>
          </mat-menu>
        }
      </ng-template>
    </div>

    @if (clickedRow()) {
      <div class="canvas">

        <app-order-details-canvas
          [orderId]="clickedRow()!.id"
          [openUpdatePaymentModal]="openUpdatePaymentModal.bind(this)"
          (canvasClose)="clearClickedRowItem()"
        />
      </div>
    }
  </div>
}

